---
phase: 12-api-throttling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/places.ts
  - src/hooks/useVenues.ts
  - app/venue/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Home screen triggers at most one Foursquare API call per 5-minute cache window"
    - "Search returns at most 3 venues, each with at most 1 photo"
    - "Venue detail screen makes zero additional Foursquare photo API calls"
    - "Navigating back and forth between home and venue detail does not re-trigger venue search"
  artifacts:
    - path: "src/services/places.ts"
      provides: "Throttled Foursquare search (limit=3, 1 photo per venue)"
      contains: "limit=3"
    - path: "src/hooks/useVenues.ts"
      provides: "Stable effect dependencies preventing re-fetch loops"
    - path: "app/venue/[id].tsx"
      provides: "Venue detail using cached photos only (no fetchPlacePhotos call)"
  key_links:
    - from: "src/services/places.ts"
      to: "src/hooks/useVenues.ts"
      via: "searchNearbyVenues import"
      pattern: "searchNearbyVenues"
    - from: "src/hooks/useVenues.ts"
      to: "src/stores/venueStore.ts"
      via: "isVenueCacheValid check before fetch"
      pattern: "isVenueCacheValid"
    - from: "app/venue/[id].tsx"
      to: "src/stores/venueStore.ts"
      via: "selectedVenue photos used directly (no API call)"
      pattern: "venue\\.photo_url"
---

<objective>
Minimize Foursquare API usage by reducing search results to 3 venues, capping photos at 1 per venue in search, eliminating the separate photo fetch on venue detail, and fixing effect dependencies to prevent re-fetch loops.

Purpose: Reduce API costs and improve app responsiveness by cutting ~95% of Foursquare API calls.
Output: Modified places service, useVenues hook, and venue detail screen.
</objective>

<execution_context>
@/Users/augustodoregofranke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/augustodoregofranke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/places.ts
@src/hooks/useVenues.ts
@src/stores/venueStore.ts
@app/venue/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Throttle Foursquare search and cap photos</name>
  <files>src/services/places.ts</files>
  <action>
In `fetchFsqPlaces()` (line 185), change `limit=50` to `limit=3`. This directly satisfies API-01.

In `transformToVenue()` (line 317), cap the photos array to a single photo:
- Change `const photos = (place.photos ?? []).map((p) => buildPhotoUrl(p, '600x400'));` to only take the first photo: `const photos = (place.photos ?? []).slice(0, 1).map((p) => buildPhotoUrl(p, '600x400'));`
- This ensures `photo_urls` has at most 1 entry per venue (API-02).

Do NOT remove the `fetchPlacePhotos` export — it may still be imported elsewhere. Just leave it as-is; the caller removal happens in Task 2.
  </action>
  <verify>
Grep for `limit=3` in places.ts to confirm the change. Grep for `slice(0, 1)` to confirm photo capping. Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
`fetchFsqPlaces` requests at most 3 venues. `transformToVenue` produces at most 1 photo URL per venue.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove photo fetch from venue detail and stabilize useVenues effect</name>
  <files>app/venue/[id].tsx, src/hooks/useVenues.ts</files>
  <action>
**app/venue/[id].tsx — Remove fetchPlacePhotos call (API-03):**
1. Remove the `fetchPlacePhotos` import from the import line (keep `getVenueTypeLabel` and `formatDistance`).
2. Remove the `fetchedPhotos` state: delete `const [fetchedPhotos, setFetchedPhotos] = useState<string[]>([]);` (line 50).
3. Remove the entire `useEffect` that calls `fetchPlacePhotos` (lines 117-126).
4. Simplify the photo merging: replace the `availablePhotos` line (line 163) with just using store photos:
   ```
   const availablePhotos = storePhotos;
   ```
   (The `fetchedPhotos` variable no longer exists, so remove the `Set` merge logic.)

**src/hooks/useVenues.ts — Fix effect dependencies (API-04):**
The auto-fetch effect (line 105-109) includes `fetchVenues` in its dependency array, and `fetchVenues` depends on `lastFetched` and `venues.length`, creating potential re-trigger cycles.

Fix by using a ref to track whether initial fetch has been done:
1. Add a ref: `const hasFetchedRef = useRef(false);`
2. Replace the auto-fetch effect with:
   ```typescript
   useEffect(() => {
     if (autoFetch && latitude && longitude && !hasFetchedRef.current) {
       hasFetchedRef.current = true;
       fetchVenues(false);
     }
   }, [autoFetch, latitude, longitude]);
   ```
3. Reset the ref when venues are cleared (permission revoked effect): add `hasFetchedRef.current = false;` inside the permission revoked block.
4. Remove `isLoading`, `venues.length`, and `fetchVenues` from the auto-fetch effect dependency array since the ref guards against re-runs.

Also remove `lastFetched` and `venues.length` from the `fetchVenues` useCallback dependency array — the cache check inside `fetchVenues` reads `lastFetched` from the store directly via `useVenueStore()`, so it does not need to be a dependency. Instead, access `lastFetched` inside the callback via `useVenueStore.getState().lastFetched` and `useVenueStore.getState().venues.length` to avoid stale closure issues while keeping stable references:
   ```typescript
   const fetchVenues = useCallback(async (force: boolean = false) => {
     if (!latitude || !longitude) {
       setError('Localização não disponível');
       return;
     }
     const currentLastFetched = useVenueStore.getState().lastFetched;
     const currentVenueCount = useVenueStore.getState().venues.length;
     if (!force && isVenueCacheValid(currentLastFetched) && currentVenueCount > 0) {
       return;
     }
     // ... rest unchanged
   }, [latitude, longitude, radius, setVenues, setLoading, setError, setLastFetched]);
   ```
  </action>
  <verify>
1. Grep `app/venue/[id].tsx` for `fetchPlacePhotos` — should return zero matches.
2. Grep `src/hooks/useVenues.ts` for `hasFetchedRef` — should find the ref usage.
3. Run `npx tsc --noEmit` to verify no type errors.
4. Run `npx expo export --platform ios --dump-sourcemap 2>&1 | head -5` or just `npx tsc --noEmit` to confirm the build compiles.
  </verify>
  <done>
Venue detail screen shows only cached photos from the search response (zero additional API calls). The useVenues hook fetches exactly once per mount when location is available, respects the 5-minute cache, and does not re-trigger on navigation.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "limit=3" src/services/places.ts` — confirms API-01
2. `grep -n "slice(0, 1)" src/services/places.ts` — confirms API-02
3. `grep -c "fetchPlacePhotos" app/venue/[id].tsx` — returns 0, confirms API-03
4. `grep -n "hasFetchedRef" src/hooks/useVenues.ts` — confirms API-04
5. `npx tsc --noEmit` — no type errors
</verification>

<success_criteria>
- Foursquare search URL contains `limit=3` (was 50)
- Each venue in search results has at most 1 photo URL
- Venue detail screen has zero `fetchPlacePhotos` calls
- useVenues auto-fetch effect runs exactly once per mount cycle
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-api-throttling/12-01-SUMMARY.md`
</output>
